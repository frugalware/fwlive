#!/bin/bash

# (c) 2005 Marcus Habermehl <bmh1980de@yahoo.de>
# (c) 2003 Vajna Miklos <vmiklos@frugalware.org>
# rc.frugalware for Frugalware
# distributed under GPL License

# chkconfig: 2345 00 94
# description: Save/restore settings from a config file.

source /lib/initscripts/functions
TEXTDOMAIN=fwlive
TEXTDOMAINDIR=/usr/share/locale
CONFFILE="`ls -1 /{media,mnt}/*/fwliveconf.mo 2>/dev/null | head -n 1`"
FWCONF=$"\e[01mFWLive config file!\e[0m"
NOFWCONF=$"\e[01mNO FWLive config file!\e[0m"

actions=(start stop save restore)

rc_save()
{
	rc_stop
}

rc_restore()
{
	rc_start
}

rc_start()
{
	start $"Searching for a previous FWLive configuration file"
	if [ "$CONFFILE" != "" ]; then
		ok 0
		hint $"Found an FWLive config file."
                if message_skipped "`printf $"Do you want to restore saved settings from %s?\n" $CONFFILE`" 9; then
			/usr/local/bin/configrestore $CONFFILE
		fi
	else
		ok 999
		hint $"No previous FWLive config file found."
	fi
}

# $1 = message text (y/n question)
# $2 = timeout (integer)
message_skipped()
{
	i=$2; echo -ne "$1\n"
	desc=$"enter=confirm"
	echo -ne "\e[01;36m $i s     \e[0m[ $desc ]	\r"
		while [ $i -gt 0 ]; do
			i=$(($i-1))
			read -t 1 -s -n 1 CHAR
				if [ $? = 0 -a "$CHAR" = "" ]; then echo; return 1; fi
			echo -ne "\e[01;36m $i s     \e[0m[ $desc ]	\r"
		done
	echo -e $"\nTimed out. Never mind, skipped."
	return 0
}

rc_stop()
{
# automatically restore/save settings in the case fwliveconf.lzm is found
# in root directory of any partition. Only the first one is used.
	start $"Storing FWLive configuration file"
	if [ "$CONFFILE" != "" ]; then
		ok 0
		hint $"Found an FWLive config file."
		if ! message_skipped "`printf $"Save settings to %s?\n" $CONFFILE`" 9; then
			/usr/local/bin/configsave $CONFFILE
		fi
	else
		echo -e "$NOFWCONF"
		if ! message_skipped "SAVE settings?" 9; then
			echo -n "Please give config install path [/media/sda*]: "
			read UTVONAL
			if [ "$UTVONAL" != "" ] && [ -d "$UTVONAL" ]; then
				/usr/local/bin/configsave $UTVONAL/fwliveconf.mo
			else
				hint $"No such directory.";
				ok 1
			fi
		fi
	fi

}

rc_exec $1

# vim: ft=sh
